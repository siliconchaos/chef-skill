name: Automated Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  release:
    name: Create Automated Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Bump version, update CHANGELOG.md, tag, and commit
      # Conventional commit prefixes:
      #   feat!: / BREAKING CHANGE:  → major
      #   feat:                      → minor
      #   fix: / other               → patch
      - name: Conventional Changelog Action
        id: changelog
        uses: TriPSs/conventional-changelog-action@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          git-message: 'chore(release): {version}'
          git-user-name: 'github-actions[bot]'
          git-user-email: 'github-actions[bot]@users.noreply.github.com'
          preset: 'angular'
          tag-prefix: 'v'
          output-file: 'CHANGELOG.md'
          version-file: './.claude-plugin/marketplace.json'
          version-path: 'version'
          skip-on-empty: 'false'
          skip-version-file: 'false'
          skip-commit: 'false'

      # Sync plugins[0].version in marketplace.json and version in SKILL.md frontmatter
      - name: Sync Plugin Version and SKILL.md
        if: steps.changelog.outputs.skipped == 'false'
        env:
          VERSION: ${{ steps.changelog.outputs.version }}
        run: |
          python3 << 'EOF'
          import json
          import os
          import re
          import sys

          version = os.environ['VERSION']

          # 1. Sync plugins[0].version in marketplace.json
          with open('.claude-plugin/marketplace.json', 'r') as f:
              data = json.load(f)

          if 'plugins' not in data or len(data['plugins']) == 0:
              print('ERROR: No plugins found in marketplace.json')
              sys.exit(1)

          data['plugins'][0]['version'] = version

          with open('.claude-plugin/marketplace.json', 'w') as f:
              json.dump(data, f, indent=2)
              f.write('\n')

          print(f'Synced marketplace.json plugins[0].version to {version}')

          # 2. Sync version in chef-automate/SKILL.md frontmatter
          skill_path = 'chef-automate/SKILL.md'
          with open(skill_path, 'r') as f:
              content = f.read()

          updated = re.sub(r'(?m)^version:\s+[\d.]+', f'version: {version}', content)

          if updated == content:
              print(f'ERROR: Could not find "version: X.Y.Z" in {skill_path} frontmatter')
              sys.exit(1)

          with open(skill_path, 'w') as f:
              f.write(updated)

          print(f'Synced {skill_path} version to {version}')
          print(f'\nAll versions synchronized to {version}')
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .claude-plugin/marketplace.json chef-automate/SKILL.md
          git commit --amend --no-edit
          git push --force-with-lease

      - name: Create GitHub Release
        if: steps.changelog.outputs.skipped == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.changelog.outputs.tag }}
          name: ${{ steps.changelog.outputs.tag }}
          body: ${{ steps.changelog.outputs.clean_changelog }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        if: steps.changelog.outputs.skipped == 'false'
        env:
          VERSION: ${{ steps.changelog.outputs.version }}
          TAG: ${{ steps.changelog.outputs.tag }}
          CLEAN_CHANGELOG: ${{ steps.changelog.outputs.clean_changelog }}
          REPOSITORY: ${{ github.repository }}
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** $TAG" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** https://github.com/$REPOSITORY/releases/tag/$TAG" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changelog" >> $GITHUB_STEP_SUMMARY
          echo "$CLEAN_CHANGELOG" >> $GITHUB_STEP_SUMMARY
